Crashlytics Setup Demo
===========

> Crashlytics for Android delivers deep, rich crash reporting across devices in real-Â­time. Crashlytics performs a detailed analysis of every thread on every Android device to identify the most important issues.

Crashlytics is one of the crash reporting tools available to collect crash info from the user devices. Very likely you are using one of the alternatives already: Acra, Bugsense, Crittercism, etc. Crashlytics have all the features you would expect from crash reporting tool. Most important are: proguard deobfuscation, support for both handled and unhandled exceptions and no limits on free account.

Setup
-----

To be able to use Crashlytics with android project builded by gradle you need to download Crashlytics plugin for Android Studio. You would be forced to install it after first login on Crashlytics site.

Enable Crashlitics by adding crashlytics plugin and compile dependency to your project build script.

_app/build.gradle_
```java
apply plugin: 'crashlytics'

dependencies {
	compile 'com.crashlytics.android:crashlytics:1.+'
}
```

Then start Crashlytics from application entry point and that's all is needed to catch unhandled exception on server.

_src/java/com.github.plastiv.crashlyticsdemo.CrashlyticsDemoApplication
```java
public class CrashlyticsDemoApplication extends Application {

  @Override
  public void onCreate() {
    super.onCreate();
    Crashlytics.start(this);
  }
}
```

Wait, you would ask how does Crashlytics authorize SDK and knows where to send the crashes?

Crashlytics gradle plugin generates additional files with supporting information for that. After building the project you would see next autogenerated modification to you sources:

_app/src/main/assets/crashlytics-build.properties_
```ini
version_name=0.0.1
package_name=com.example.app
build_id=d8ba607c-1abc-49c5-9f55-2f45b7de083b
version_code=3
app_name=Example app
```

_app/src/main/res/values/com_crashlytics_export_strings.xml_
```xml
<resources>
    <string name="com.crashlytics.android.build_id" translatable="false">d8ba607c-1abc-49c5-9f55-2f45b7de083b</string>
</resources>
```

_app/src/main/AndroidManifest.xml_

```xml
<meta-data
      android:name="com.crashlytics.ApiKey"
      android:value="cc238b2a4866ceb061b008839cdb49a8b77"/>
```

Both `crashlytics-build.properties` and `com_crashlytics_export_strings.xml` are autogenerated files and should be excluded from source control as they would be modified on each build by Crashlytics plugin. Meta data at AndroidManifest not needed to be hardcoded as it would be autogenerated also.

_.gitignore_
```ini
# Crashlytics plugin
com_crashlytics_export_strings.xml
crashlytics.properties
crashlytics-build.properties
```

Version name, code and package will be loaded from gradle build script. Crashlytics credentials can be contolled from `crashlytics.properties` file.

_app/crashlytics.properties_
```ini
apiSecret=7c9df6d057e7bb62b17ab364e8115a75fcf7430873b6274bb094d1a8adb
apiKey=cc238b2a4866ceb061b008839cdb49a8b77
```

You can get apiSecret and apiKey from `~/.crashlytics/User.json` where it was created after successful login withing Crashlytics plugin for AndroidStudio. It make sense to keep this values private without sharing them within repository so we added `crashlytics.properties` file to the `.gitignore` too.

Disable Crashlytics for the debug builds
---

You may want to disable Crashlytics crash logging during debugging on local machine. You can see all crashed directly at the adb logcat with no need to use server infrastructure and be reported by mail. This could be done with gradle flavors and `ext.enableCrashlytics` parameter.

_app/build.gradle_
```java
android {
    buildTypes {
        debug {
            // disable crashlytics
            buildConfigField "boolean", "USE_CRASHLYTICS", "false"
            ext.enableCrashlytics = false
        }
        release {
            // enable crashlytics
            buildConfigField "boolean", "USE_CRASHLYTICS", "true"
            ext.enableCrashlytics = true
        }
    }
}
```

After disabling Crashlytics gradle plugin with `ext.enableCrashlytics = false` it stops to create autogenerated `crashlytics-build.properties` and `com_crashlytics_export_strings.xml` files, which will results in exception for the Crashlytics initialization from code. Wrap `Crashlytics.start()` with declared build config field to prevent exception.

```java
@Override
public void onCreate() {
    if (BuildConfig.USE_CRASHLYTICS) {
        Crashlytics.start(this);
    }
}
```

Providing apiKey and apiSecret on CI
------

You may want to keep your apiKey and apiSecret private without sharing it within git repository. But you still need this values to be able to run build from CI or other team members machines. Same technique is used here as when we hiding signingConfig keys from repository by providing it with project properties.

_app/build.gradle_
```java
afterEvaluate {
    initCrashlyticsPropertiesIfNeeded()
}

def initCrashlyticsPropertiesIfNeeded() {
    def propertiesFile = file('crashlytics.properties')
    if (!propertiesFile.exists()) {
        def commentMessage = "This is autogenerated crashlytics property from system environment to prevent key to be committed to source control."
        ant.propertyfile(file: "crashlytics.properties", comment: commentMessage) {
            entry(key: "apiSecret", value: crashlyticsdemoApisecret)
            entry(key: "apiKey", value: crashlyticsdemoApikey)
        }
    }
}
```

Additional task is added which will autogenerate `crashlytics.properties` file with `crashlyticsdemoApisecret` and `crashlyticsdemoApikey` project properties. With gradle it is really conviniet to set this project property. Choose option which suits you best:

* First of all we can hardcode the properties in the script itself
* Or use the -P command-line argument to pass a property to the build script.

`gradlew assemble -PcrashlyticsdemoApikey=cc238b2a4866c96030`

* Define a gradle.properties file and set the property in this file. We can place the file in our project directory or in the <USER_HOME>/.gradle directory. The properties defined in the property file in our home directory take precedence over the properties defined in the file in our project directory.

`gradle.properties` or `~/.gradle/gradle.properties`

```ini
crashlyticsdemoApisecret=0cf7c9df6d057e7bb62b1427ab364e8115a75fcf7430873b6274bb094d1a8adb
crashlyticsdemoApikey=cc238b2a4866c96030
```

* We can use an environment variable of which the name starts with ORG_GRADLE_PROJECT_ followed by the property name.

`export ORG_GRADLE_PROJECT_crashlyticsdemoApikey=cc238b2a4866c96030`

* Or we use the Java system property that starts with org.gradle.project. followed by the property name.

`java -Dorg.gradle.project.crashlyticsdemoApikey="cc238b2a4866c96030"`

Custom source sets
-------

If you override default source folder structure with gradle, for example to made project compatible with Eclipse, you should override Crashlytics sourceSet also so it knows where to place autogenerated files.

_app/build.gradle_
```java
crashlytics.manifestPath = "relative/path/to/manifest"
crashlytics.resPath = "relative/path/to/res"
crashlytics.assetsPath = "relative/path/to/assets"
```
